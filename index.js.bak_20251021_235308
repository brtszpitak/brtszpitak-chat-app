import downloadRouter from './routes/download.js';
import adminRouter from './routes/admin.js';
import execGuard from './routes/exec-guard.js';
// Bootstrapped by Alice on 2025-10-21_23-03-35
// [ALICE-BOOTSTRAP] BEGIN
// D:\Alice\projects\chat-app\index.js
// PROOF-OF-LIFE SERVER (clearly logs its own path & settings)
// - Fixes browser 500s by accepting /chat and /chat-json
// - Adds /debug/echo to see exactly what the server receives
// - Streams NDJSON from Ollama with /api/generate and fallback to /api/chat
// - Logs startup banner with __filename, client dist path, Node version, and port

import express from "express";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const CLIENT_DIST = path.join(__dirname, "client", "dist");
const PORT = 3001;

const app = express();
app.use(express.json());
app.disable("x-powered-by");

// Ã¢â‚¬â€Ã¢â‚¬â€ Crash visibility
process.on("uncaughtException", (e) => console.error("UNCAUGHT", e));
process.on("unhandledRejection", (e) => console.error("UNHANDLED", e));

// Ã¢â‚¬â€Ã¢â‚¬â€ Body parsers (JSON + text to handle odd clients)
app.use(express.json({ limit: "2mb" }));
app.use(express.text({ type: "*/*", limit: "2mb" }));

// Ã¢â‚¬â€Ã¢â‚¬â€ Request logger (first 200 chars of body)
app.use((req, _res, next) => {
  const b =
    typeof req.body === "string"
      ? req.body.slice(0, 200)
      : JSON.stringify(req.body)?.slice(0, 200);
  console.log(
    `[${new Date().toISOString()}] ${req.method} ${req.url} ct=${req.headers["content-type"]} body=${b}`
  );
  next();
});

// Ã¢â‚¬â€Ã¢â‚¬â€ Health
app.get("/health", (_req, res) => res.json({ status: "ok" }));

// Ã¢â‚¬â€Ã¢â‚¬â€ Version passthrough to Ollama
app.get("/ollama/version", async (_req, res) => {
  try {
    const r = await fetch("http://127.0.0.1:11434/api/version");
    const text = await r.text();
    res.type(r.headers.get("content-type") || "application/json").send(text);
  } catch (e) {
    console.error("VERSION ERROR", e);
    res.status(500).json({ error: String(e?.message || e) });
  }
});

// Ã¢â‚¬â€Ã¢â‚¬â€ DEBUG: echo exactly what the server sees
app.all("/debug/echo", (req, res) => {
  res.json({
    method: req.method,
    url: req.url,
    headers: req.headers,
    typeofBody: typeof req.body,
    body: req.body,
  });
});

// Ã¢â‚¬â€Ã¢â‚¬â€ Helper: normalize input from body
function extractInput(req) {
  const b = req.body;
  if (b == null) return null;

  if (typeof b === "string") {
    try {
      const maybe = JSON.parse(b);
      if (maybe && typeof maybe === "object") {
        return maybe.prompt ?? maybe.message ?? null;
      }
    } catch {
      // plain text
      return b.trim() || null;
    }
  }

  if (typeof b === "object") {
    return b.prompt ?? b.message ?? null;
  }
  return null;
}

// Ã¢â‚¬â€Ã¢â‚¬â€ Chat handler (streams NDJSON)
async function chatHandler(req, res) {
  try {
    const input = extractInput(req);
    if (!input || typeof input !== "string") {
      return res.status(400).json({ error: "Missing prompt/message" });
    }

    const raw = typeof req.body === "string" ? (() => { try { return JSON.parse(req.body); } catch { return {}; } })() : (req.body || {});
    const model = raw.model || "alice:latest";
    const temperature = typeof raw.temperature === "number" ? raw.temperature : 0.7;
    const stop = Array.isArray(raw.stop) ? raw.stop : undefined;

    // Try /api/generate
    let upstream = await fetch("http://127.0.0.1:11434/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model,
        prompt: input,
        stream: true,
        options: { temperature, stop },
      }),
    });

    // Fallback: /api/chat
    if (upstream.status === 404) {
      console.warn("Fallback to /api/chat");
      upstream = await fetch("http://127.0.0.1:11434/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model,
          messages: [{ role: "user", content: input }],
          stream: true,
          options: { temperature, stop },
        }),
      });
    }

    if (!upstream.ok || !upstream.body) {
      const errText = await upstream.text().catch(() => "");
      console.error("UPSTREAM ERROR", upstream.status, errText);
      return res
        .status(502)
        .json({ error: "Upstream error", status: upstream.status, body: errText });
    }

    res.setHeader("Content-Type", "application/x-ndjson; charset=utf-8");
    res.setHeader("Cache-Control", "no-cache, no-transform");
    res.setHeader("Connection", "keep-alive");

    const reader = upstream.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      if (value?.length) res.write(value);
    }
    res.write("\n");
    res.end();
  } catch (e) {
    console.error("CHAT ERROR", e);
    if (!res.headersSent) {
      res.status(500).json({ error: String(e?.message || e), stack: e?.stack });
    } else {
      try { res.end(); } catch {}
    }
  }
}

// Ã¢â‚¬â€Ã¢â‚¬â€ Routes
app.post("/chat", chatHandler);
app.post("/chat-json", chatHandler); // alias for older/newer web clients

// Ã¢â‚¬â€Ã¢â‚¬â€ Static client
app.use(express.static(CLIENT_DIST, { fallthrough: true }));

// Ã¢â‚¬â€Ã¢â‚¬â€ SPA fallback (donÃ¢â‚¬â„¢t swallow API routes)
app.use(execGuard);
app.use('/download', downloadRouter);
app.use('/admin', adminRouter);

app.get("*", (req, res, next) => {
  if (req.method !== "GET") return next();
  const p = req.path;
  if (p.startsWith("/api/") || p.startsWith("/ollama/") || p.startsWith("/chat")) return next();
  if (p.startsWith("/chat-json") || p.startsWith("/debug/")) return next();
  res.sendFile(path.join(CLIENT_DIST, "index.html"));
});

// Ã¢â‚¬â€Ã¢â‚¬â€ Start (prints proof-of-life banner)
app.listen(PORT, () => {
  console.log("===============================================");
  console.log(" Alice Server is running");
  console.log(` Node:           ${process.versions.node}`);
  console.log(` File:           ${__filename}`);
  console.log(` Client (dist):  ${CLIENT_DIST}`);
  console.log(` Port:           http://localhost:${PORT}`);
  console.log("===============================================");
});

// [ALICE-BOOTSTRAP] END

